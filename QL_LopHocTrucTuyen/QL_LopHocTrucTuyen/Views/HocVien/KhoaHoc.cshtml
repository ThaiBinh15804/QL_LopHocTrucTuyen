@using QL_LopHocTrucTuyen.Models;

@model QL_LopHocTrucTuyen.Models.KhoaHoc

@{
    ViewBag.Title = "KhoaHoc";
    Layout = "~/Views/Shared/_LayoutHocVien.cshtml";
}

<div class="container mt-4">
    <div class="row">
        <!-- Sidebar bên trái -->
        <div class="col-md-3 bg-dark" id="sidebar">
            <button class="btn btn-secondary mb-3 w-25 mt-2" onclick="window.history.back();">Trở lại</button>
            <div class="bg-secondary text-white p-3 rounded">
                <h5 class="fw-bold">@Model.TenKhoaHoc</h5>
                <div class="progress mt-2" style="height: 8px;">
                    <div class="progress-bar bg-white" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <p class="mt-2 mb-0">0% Đã hoàn thành</p>
            </div>
            <!-- Danh sách chương và bài giảng với Bootstrap Accordion -->
            <div class="accordion mt-3" id="courseAccordion">
                @foreach (var chuong in Model.Chuongs)
                {
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-@chuong.MaChuong">
                            <button class="accordion-button collapsed bg-secondary text-white fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-@chuong.MaChuong" aria-expanded="false" aria-controls="collapse-@chuong.MaChuong">
                                <i class="bi bi-journal-text me-2"></i>@chuong.TenChuong
                            </button>
                        </h2>
                        <div id="collapse-@chuong.MaChuong" class="accordion-collapse collapse" aria-labelledby="heading-@chuong.MaChuong" data-bs-parent="#courseAccordion">
                            <div class="accordion-body p-0">
                                <ul class="list-group list-group-flush">
                                    @foreach (var baiGiang in chuong.BaiGiangs)
                                    {
                                        <li class="list-group-item d-flex align-items-center" style="cursor: pointer;" onclick="loadBaiGiang(@baiGiang.MaBaiGiang)">
                                            <i class="bi bi-play-circle text-secondary me-2"></i>
                                            <span>@baiGiang.TenBaiGiang</span>
                                        </li>
                                        <!-- Phần bài tập cho từng bài giảng -->
                                        <ul class="list-group list-group-flush ps-4" id="baiTapList-@baiGiang.MaBaiGiang">
                                            <!-- Danh sách bài tập sẽ được tải động từ JavaScript -->
                                        </ul>
                                    }
                                </ul>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
        <!-- Nội dung bài giảng -->
        <div class="col-md-9" id="mainContent">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <button class="btn btn-outline-secondary" id="toggleSidebar"><i class="bi bi-list"></i></button>
                <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#hoidapModal">
                    <i class="bi bi-chat-dots"></i> Hỏi đáp
                </button>
            </div>

            <!-- Phần video với nền xám nhạt -->
            <div class="p-4 rounded bg-light" id="videoContent">
                <div class="ratio ratio-16x9" id="videoContainer">
                    <iframe id="videoIframe" src="" allowfullscreen></iframe>
                </div>
                <h5 id="tenBaiGiang" class="mt-3 fw-bold"></h5>
                <p id="noiDungBaiGiang" class="text-muted"></p>
            </div>
            <!-- Nút hoàn tất căn phải bên dưới video -->
            <div class="d-flex justify-content-end mt-3 mb-4">
                <button id="btnNext" class="btn btn-primary">Hoàn Tất & Tiếp Tục</button>
            </div>
            <!-- Thêm input ẩn để lưu trữ ID của bài giảng hiện tại -->
            <input type="hidden" id="currentBaiGiangId" value="" />
        </div>
    </div>
</div>
<!-- Modal Form Hỏi đáp -->
<div class="modal fade" id="hoidapModal" tabindex="-1" aria-labelledby="hoidapModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-slideout">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="hoidapModalLabel">Hỏi đáp</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Form bình luận -->
                <div class="mb-3">
                    <textarea class="form-control" rows="3" placeholder="Nhập bình luận mới của bạn"></textarea>
                    <div class="text-end mt-2">
                        <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button class="btn btn-primary">Bình luận</button>
                    </div>
                    <!-- Khu vực hiển thị bình luận -->
                    <h5 class="mt-4">Bình luận</h5>
                    <div id="binhLuanContainer"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- CSS Tùy chỉnh để modal xuất hiện bên phải và che một nửa màn hình -->
<style>
    .modal-dialog-slideout {
        position: fixed;
        right: 0;
        top: 0;
        bottom: 0;
        width: 50%; /* Chiếm 50% chiều rộng màn hình */
        max-width: none;
        margin: 0;
    }
</style>
<!-- Bootstrap Script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

@{
    bool hasChuong = Model.Chuongs.Any();
    bool hasBaiGiang = hasChuong && Model.Chuongs.First().BaiGiangs.Any();
    int? firstBaiGiangId = hasBaiGiang ? Model.Chuongs.First().BaiGiangs.First().MaBaiGiang : (int?)null;
}

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>

       function loadBaiGiang(id) {
    $.ajax({
        url: '/HocVien/XemBaiGiang',
        type: 'GET',
        data: { id: id },
        success: function(response) {
            console.log(response); // Kiểm tra dữ liệu trả về từ API
            if (response.success) {
                let videoURL = response.data.URL;
                if (videoURL.includes("watch?v=")) {
                    videoURL = videoURL.replace("watch?v=", "embed/");
                }

                // Hiển thị thông tin bài giảng
                $('#tenBaiGiang').text(response.data.TenBaiGiang);
                $('#noiDungBaiGiang').html(response.data.NoiDung);
                $('#videoIframe').attr('src', videoURL);

                // Xóa danh sách bài tập cũ cho bài giảng hiện tại
                $('#baiTapList-' + id).empty();

                // Kiểm tra và hiển thị danh sách bài tập nếu có
                if (response.data.BaiTaps && response.data.BaiTaps.length > 0) {
                    console.log("Danh sách bài tập:", response.data.BaiTaps);
                    response.data.BaiTaps.forEach(function(baiTap) {
                        $('#baiTapList-' + id).append(
                            '<li class="list-group-item d-flex align-items-center" style="cursor: pointer;">' +
                            '<i class="bi bi-file-earmark-text me-2"></i>' +
                            '<a href="/Content/HocVien/BaiTap/' + baiTap.FileUpload + '" target="_blank" class="text-decoration-none">' + baiTap.TenBaiTap + '</a>' +
                            '</li>'
                        );
                    });
                } else {
                    $('#baiTapList-' + id).append('<li class="list-group-item">Không có bài tập nào</li>');
                }

                // Cập nhật ID của bài giảng tiếp theo vào nút "Hoàn Tất & Tiếp Tục"
                $('#btnNext').data('nextBaiGiangId', response.data.NextBaiGiangId);
            } else {
                alert(response.message);
            }
        },
        error: function(xhr, status, error) {
            console.error("Lỗi khi gọi API XemBaiGiang:", error);
            alert("Có lỗi xảy ra khi tải bài giảng.");
        }
    });
}

    // Bắt sự kiện click vào nút "Hoàn Tất & Tiếp Tục"
    $('#btnNext').click(function() {
        var nextBaiGiangId = $(this).data('nextBaiGiangId');
        if (nextBaiGiangId) {
            loadBaiGiang(nextBaiGiangId);
        } else {
            alert("Đã hoàn thành tất cả các bài giảng.");
        }
    });

    // Sử dụng nút để ẩn/hiện sidebar
    $('#toggleSidebar').click(function() {
        $('#sidebar').toggleClass('d-none');
        $('#mainContent').toggleClass('col-md-9 col-12');
    });

    // Sử dụng các biến đã được khởi tạo từ Razor
    const hasBaiGiang = @hasBaiGiang.ToString().ToLower();
    const firstBaiGiangId = hasBaiGiang ? '@firstBaiGiangId' : null;

    // Tự động tải bài giảng đầu tiên khi trang được tải
    $(document).ready(function() {
        if (hasBaiGiang && firstBaiGiangId) {
            loadBaiGiang(firstBaiGiangId);
        }
    });


    </script>
}
